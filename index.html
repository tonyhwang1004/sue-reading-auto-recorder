<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>실제 AI 슬라이드 자동 생성기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            padding: 40px 20px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 20px;
            margin-bottom: 40px;
            backdrop-filter: blur(10px);
        }

        .logo {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .title {
            font-size: 2.8em;
            font-weight: 900;
            margin-bottom: 15px;
            background: linear-gradient(45deg, #00ffff, #ff00ff, #ffff00);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: gradientFlow 3s ease-in-out infinite;
        }

        @keyframes gradientFlow {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(180deg); }
        }

        .subtitle {
            font-size: 1.3em;
            opacity: 0.9;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .description {
            font-size: 1.1em;
            opacity: 0.8;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .api-setup {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid rgba(255, 0, 0, 0.3);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            text-align: center;
        }

        .api-setup.configured {
            background: rgba(0, 255, 0, 0.1);
            border-color: rgba(0, 255, 0, 0.3);
        }

        .api-input {
            width: 100%;
            max-width: 500px;
            padding: 15px;
            margin: 15px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            color: white;
            font-size: 1.1em;
        }

        .api-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 25px;
            padding: 40px;
            margin: 40px 0;
            transition: all 0.3s ease;
        }

        .input-section:hover {
            border-color: rgba(0, 255, 255, 0.5);
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-label {
            font-size: 1.3em;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 10px;
            display: block;
        }

        .input-field {
            width: 100%;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            color: white;
            font-size: 1.1em;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .input-field:focus {
            outline: none;
            border-color: #00ffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
        }

        .input-field::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .textarea-field {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }

        .generate-button {
            display: block;
            width: 100%;
            max-width: 500px;
            margin: 50px auto;
            padding: 25px;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4, #45b7d1, #96ceb4, #feca57);
            background-size: 300% 300%;
            border: none;
            border-radius: 25px;
            font-size: 1.8em;
            font-weight: 900;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 2px;
            animation: gradientShift 4s ease infinite;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        .generate-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            animation: none;
        }

        .generate-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.4);
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin: 40px 0;
        }

        .feature-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(0, 255, 255, 0.5);
        }

        .feature-icon {
            font-size: 3.5em;
            margin-bottom: 20px;
        }

        .feature-title {
            font-size: 1.4em;
            font-weight: 700;
            margin-bottom: 10px;
            color: #00ffff;
        }

        .feature-desc {
            font-size: 1em;
            opacity: 0.8;
            line-height: 1.4;
        }

        .status-panel {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .status-panel.show {
            display: block;
        }

        .status-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #00ffff;
        }

        .ai-thinking {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 20px 0;
        }

        .thinking-dots {
            display: flex;
            gap: 5px;
        }

        .thinking-dot {
            width: 12px;
            height: 12px;
            background: #00ffff;
            border-radius: 50%;
            animation: thinking 1.4s ease-in-out infinite both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes thinking {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .countdown {
            font-size: 4em;
            font-weight: 900;
            margin: 20px 0;
            color: #ff6b6b;
            text-shadow: 0 0 20px rgba(255, 107, 107, 0.8);
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .progress-container {
            margin: 25px 0;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff, #ff00ff);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 6px;
        }

        .progress-text {
            font-size: 1.1em;
            font-weight: 600;
        }

        .recording-status {
            display: none;
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid rgba(255, 0, 0, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .recording-status.active {
            display: block;
            animation: recordingPulse 1s ease-in-out infinite;
        }

        @keyframes recordingPulse {
            0%, 100% { border-color: rgba(255, 0, 0, 0.5); }
            50% { border-color: rgba(255, 0, 0, 1); }
        }

        .recording-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #ff0000;
            border-radius: 50%;
            margin-right: 10px;
            animation: blink 1s ease-in-out infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        .preview-section {
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 25px;
            margin: 30px 0;
            border: 2px solid rgba(255, 255, 255, 0.1);
            display: none;
        }

        .preview-section.show {
            display: block;
        }

        .preview-title {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 15px;
            color: #00ffff;
            text-align: center;
        }

        .slide-preview {
            background: #000;
            border-radius: 15px;
            width: 300px;
            height: 533px;
            margin: 0 auto 20px;
            overflow: hidden;
            border: 3px solid #333;
            position: relative;
        }

        .ai-analysis {
            background: rgba(0, 255, 0, 0.1);
            border: 2px solid rgba(0, 255, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .sample-templates {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .template-card {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .template-card:hover {
            border-color: #00ffff;
            transform: translateY(-5px);
        }

        .template-card.selected {
            border-color: #00ffff;
            background: rgba(0, 255, 255, 0.1);
        }

        .template-name {
            font-size: 1.2em;
            font-weight: 700;
            color: #00ffff;
            margin-bottom: 10px;
        }

        .template-desc {
            font-size: 0.9em;
            opacity: 0.8;
        }

        .hidden {
            display: none !important;
        }

        /* 반응형 디자인 */
        @media (max-width: 768px) {
            .title {
                font-size: 2.2em;
            }

            .generate-button {
                font-size: 1.4em;
                padding: 20px;
            }

            .countdown {
                font-size: 3em;
            }

            .input-section {
                padding: 25px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">🤖</div>
            <h1 class="title">실제 AI 슬라이드 생성기</h1>
            <p class="subtitle">GPT-4 API로 실제 AI가 슬라이드를 분석하고 자동 생성</p>
            <p class="description">
                진짜 OpenAI GPT-4 API를 사용해서 당신의 내용을 지능적으로 분석하고, 
                11장의 전문적인 슬라이드를 자동 생성하여 완벽한 27.5초 유튜브 쇼츠 영상을 만들어드립니다.
            </p>
        </div>

        <!-- GPT API 설정 -->
        <div class="api-setup" id="apiSetup">
            <h3>🔑 OpenAI API 키 설정 (필수)</h3>
            <p>실제 GPT-4 AI를 사용하려면 OpenAI API 키가 필요합니다.</p>
            <input type="password" class="api-input" id="apiKeyInput" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx">
            <br>
            <button onclick="setApiKey()" style="padding: 10px 20px; background: #00ffff; color: #000; border: none; border-radius: 10px; margin: 10px; cursor: pointer;">API 키 설정</button>
            <button onclick="showApiGuide()" style="padding: 10px 20px; background: #ff6b6b; color: white; border: none; border-radius: 10px; margin: 10px; cursor: pointer;">API 키 발급 방법</button>
            <div id="apiStatus" style="margin-top: 15px; font-weight: bold;"></div>
        </div>

        <!-- 기능 소개 -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">🧠</div>
                <div class="feature-title">실제 GPT-4 AI 분석</div>
                <div class="feature-desc">OpenAI의 최신 GPT-4 모델이 당신의 내용을 지능적으로 분석하고 최적의 슬라이드 구조를 생성</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">🎨</div>
                <div class="feature-title">스마트 디자인 선택</div>
                <div class="feature-desc">AI가 내용의 성격을 파악해서 가장 적합한 색상, 아이콘, 레이아웃을 자동 선택</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">📊</div>
                <div class="feature-title">지능적 정보 구조화</div>
                <div class="feature-desc">연락처, 통계, 기능 등을 AI가 자동으로 분류하고 최적의 슬라이드 순서로 배치</div>
            </div>
            <div class="feature-card">
                <div class="feature-icon">⚡</div>
                <div class="feature-title">실시간 AI 생성</div>
                <div class="feature-desc">시뮬레이션이 아닌 실제 GPT API 호출로 매번 새롭고 창의적인 슬라이드 생성</div>
            </div>
        </div>

        <!-- 템플릿 선택 -->
        <div class="input-section">
            <h3 style="color: #00ffff; margin-bottom: 20px; font-size: 1.5em;">📋 AI 분석 템플릿</h3>
            <div class="sample-templates">
                <div class="template-card selected" data-template="business">
                    <div class="template-name">비즈니스</div>
                    <div class="template-desc">회사/서비스 소개, 마케팅용</div>
                </div>
                <div class="template-card" data-template="education">
                    <div class="template-name">교육</div>
                    <div class="template-desc">강의, 튜토리얼, 설명용</div>
                </div>
                <div class="template-card" data-template="product">
                    <div class="template-name">제품</div>
                    <div class="template-desc">제품 소개, 기능 설명용</div>
                </div>
                <div class="template-card" data-template="personal">
                    <div class="template-name">개인</div>
                    <div class="template-desc">자기소개, 포트폴리오용</div>
                </div>
            </div>
        </div>

        <!-- 입력 섹션 -->
        <div class="input-section">
            <div class="input-group">
                <label class="input-label">📝 제목</label>
                <input type="text" class="input-field" id="titleInput" placeholder="예: Sue Reading Club - AI 영어교육의 혁신" maxlength="100">
            </div>

            <div class="input-group">
                <label class="input-label">📄 상세 내용 (AI가 분석할 모든 정보)</label>
                <textarea class="input-field textarea-field" id="contentInput" placeholder="예: 
Sue Reading Club은 AI 기반 영어교육 서비스입니다.

주요 프로그램:
- AI 독해 시스템: 개인별 맞춤 분석으로 독해력 향상
- 스마트 속독: 과학적 훈련법으로 읽기 속도 3배 향상  
- AI 토론 클래스: AI와 함께하는 실시간 토론 학습
- 실시간 피드백: 즉석에서 제공되는 정확한 피드백
- AI 개별 분석: 학습자의 읽기 패턴 실시간 분석

성과:
- 98% 학부모 만족도
- 3.2배 읽기속도 향상

위치: 인천 연수구 송도동 해온더라운지 702호
연락처: 010-9579-4429
상담시간: 평일 09:00-18:00

특별 혜택: 첫 달 30% 할인"></textarea>
            </div>

            <div class="input-group">
                <label class="input-label">🎨 컬러 테마</label>
                <select class="input-field" id="colorTheme">
                    <option value="blue-purple">파랑-보라 (기본)</option>
                    <option value="red-orange">빨강-주황</option>
                    <option value="green-teal">초록-청록</option>
                    <option value="purple-pink">보라-분홍</option>
                    <option value="dark-neon">다크-네온</option>
                    <option value="auto">AI가 자동 선택</option>
                </select>
            </div>
        </div>

        <button class="generate-button" id="generateButton" onclick="generateAISlides()" disabled>
            🤖 실제 AI로 슬라이드 생성 시작
        </button>

        <!-- AI 분석 결과 -->
        <div class="ai-analysis hidden" id="aiAnalysis">
            <h4>🧠 AI 분석 결과:</h4>
            <div id="analysisResult"></div>
        </div>

        <!-- 미리보기 섹션 -->
        <div class="preview-section" id="previewSection">
            <div class="preview-title">📱 AI 생성 슬라이드 미리보기</div>
            <div class="slide-preview" id="slidePreview">
                <!-- AI 생성된 슬라이드 미리보기 -->
            </div>
            <button class="generate-button" onclick="startRecording()" style="max-width: 300px; font-size: 1.2em; padding: 15px;">
                🎬 영상 녹화 시작
            </button>
        </div>

        <!-- 상태 패널 -->
        <div class="status-panel" id="statusPanel">
            <div class="status-title" id="statusTitle">🤖 실제 AI 분석 중...</div>
            <div class="ai-thinking" id="aiThinking">
                <div class="thinking-dots">
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                    <div class="thinking-dot"></div>
                </div>
            </div>
            <div class="countdown hidden" id="countdown">5</div>
            <div class="progress-container hidden" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text" id="progressText">0% 완료</div>
            </div>
            <div class="recording-status" id="recordingStatus">
                <span class="recording-dot"></span>
                <span>AI 영상 제작 중...</span>
            </div>
        </div>
    </div>

    <script>
        // 전역 변수 선언 - 메모리 기반 상태 관리
        let apiKey = '';
        let generatedSlideHTML = null;
        let slideshowWindow = null;
        let mediaRecorder = null;
        let recordedChunks = [];
        let selectedTemplate = 'business';
        let aiAnalysisResult = null;
        let isApiKeyValid = false;
        let isGenerating = false;

        // 유틸리티 함수 - 안전한 DOM 요소 가져오기
        function safeGetElement(id) {
            const element = document.getElementById(id);
            if (!element) {
                console.warn(`⚠️ 요소를 찾을 수 없습니다: ${id}`);
                return null;
            }
            return element;
        }

        // 유틸리티 함수 - 안전한 요소 내용 설정
        function safeSetContent(elementId, content, isHTML = false) {
            const element = safeGetElement(elementId);
            if (element) {
                if (isHTML) {
                    element.innerHTML = content;
                } else {
                    element.textContent = content;
                }
                return true;
            }
            return false;
        }

        // 유틸리티 함수 - 안전한 클래스 조작
        function safeToggleClass(elementId, className, action = 'toggle') {
            const element = safeGetElement(elementId);
            if (element) {
                switch (action) {
                    case 'add':
                        element.classList.add(className);
                        break;
                    case 'remove':
                        element.classList.remove(className);
                        break;
                    case 'toggle':
                        element.classList.toggle(className);
                        break;
                }
                return true;
            }
            return false;
        }

        // API 키 검증 함수
        function validateApiKey(key) {
            if (!key || typeof key !== 'string') {
                return { valid: false, message: '키가 제공되지 않았습니다.' };
            }
            
            const trimmedKey = key.trim();
            
            if (!trimmedKey.startsWith('sk-')) {
                return { valid: false, message: 'API 키는 "sk-"로 시작해야 합니다.' };
            }
            
            if (trimmedKey.length < 20) {
                return { valid: false, message: 'API 키가 너무 짧습니다.' };
            }
            
            return { valid: true, message: 'API 키가 유효합니다.' };
        }

        // API 키 설정 함수 - 강화된 검증 및 에러 처리
        function setApiKey() {
            try {
                const input = safeGetElement('apiKeyInput');
                const apiSetup = safeGetElement('apiSetup');
                const generateButton = safeGetElement('generateButton');
                
                if (!input) {
                    console.error('❌ API 키 입력 필드를 찾을 수 없습니다.');
                    return;
                }

                const inputValue = input.value;
                const validation = validateApiKey(inputValue);
                
                if (validation.valid) {
                    apiKey = inputValue.trim();
                    isApiKeyValid = true;
                    
                    // UI 업데이트
                    if (apiSetup) apiSetup.classList.add('configured');
                    
                    safeSetContent('apiStatus', '✅ API 키가 설정되었습니다. 이제 실제 AI 슬라이드 생성이 가능합니다!', true);
                    
                    const statusElement = safeGetElement('apiStatus');
                    if (statusElement) statusElement.style.color = '#00ff00';
                    
                    if (generateButton) {
                        generateButton.disabled = false;
                        generateButton.textContent = '🤖 실제 GPT-4 AI로 슬라이드 생성 시작';
                    }
                    
                    console.log('✅ OpenAI API 키 설정 완료');
                } else {
                    isApiKeyValid = false;
                    safeSetContent('apiStatus', `❌ ${validation.message}`, true);
                    
                    const statusElement = safeGetElement('apiStatus');
                    if (statusElement) statusElement.style.color = '#ff6b6b';
                    
                    console.warn('❌ API 키 검증 실패:', validation.message);
                }
            } catch (error) {
                console.error('❌ API 키 설정 중 오류:', error);
                safeSetContent('apiStatus', '❌ API 키 설정 중 오류가 발생했습니다.', true);
            }
        }

        // API 키 발급 방법 안내 - 개선된 가이드
        function showApiGuide() {
            const guideMessage = `🔑 OpenAI API 키 발급 방법:

1. https://platform.openai.com 접속
2. 회원가입 또는 로그인
3. 우상단 프로필 → "View API keys" 클릭
4. "Create new secret key" 클릭
5. 생성된 키를 복사해서 위에 입력

⚠️ 주의사항:
- API 사용료: GPT-4 기준 슬라이드 1개당 약 $0.06
- 새 계정에는 $5 무료 크레딧 제공
- API 키는 안전하게 보관하세요
- 키를 분실하면 재발급 받아야 합니다

💡 팁: API 키는 매우 중요한 정보이므로 다른 사람과 공유하지 마세요.`;

            alert(guideMessage);
        }

        // 템플릿 선택 이벤트 - 안전한 이벤트 핸들링
        function initTemplateSelection() {
            try {
                const templateCards = document.querySelectorAll('.template-card');
                
                if (templateCards.length === 0) {
                    console.warn('⚠️ 템플릿 카드를 찾을 수 없습니다.');
                    return;
                }

                templateCards.forEach(card => {
                    if (!card.dataset.template) {
                        console.warn('⚠️ 템플릿 데이터가 없는 카드:', card);
                        return;
                    }

                    card.addEventListener('click', function() {
                        try {
                            // 모든 카드에서 selected 클래스 제거
                            templateCards.forEach(c => c.classList.remove('selected'));
                            
                            // 현재 카드에 selected 클래스 추가
                            this.classList.add('selected');
                            
                            // 선택된 템플릿 저장
                            selectedTemplate = this.dataset.template;
                            
                            console.log('📋 템플릿 선택:', selectedTemplate);
                        } catch (error) {
                            console.error('❌ 템플릿 선택 오류:', error);
                        }
                    });
                });

                console.log(`✅ ${templateCards.length}개의 템플릿 카드 이벤트 등록 완료`);
            } catch (error) {
                console.error('❌ 템플릿 선택 초기화 오류:', error);
            }
        }

        // 실제 GPT API 호출 - 강화된 에러 처리 및 재시도 로직
        async function callGPTAPI(prompt, retryCount = 0) {
            const maxRetries = 3;
            
            try {
                console.log(`🤖 GPT-4 API 호출 시작... (시도 ${retryCount + 1}/${maxRetries + 1})`);
                
                if (!apiKey || !isApiKeyValid) {
                    throw new Error('API 키가 설정되지 않았거나 유효하지 않습니다.');
                }

                const requestBody = {
                    model: "gpt-4",
                    messages: [{
                        role: "system",
                        content: `당신은 전문적인 슬라이드 구조 생성 AI입니다. 주어진 내용을 분석해서 11장의 유튜브 쇼츠용 슬라이드 구조를 JSON 배열 형태로 생성해주세요.

각 슬라이드는 다음 형식이어야 합니다:
{
  "slideNumber": 1,
  "type": "intro|brand|feature|stats|testimonial|location|contact",
  "title": "슬라이드 제목 (25자 이내)",
  "subtitle": "부제목 또는 설명 (50자 이내)",
  "icon": "적절한 이모지 1개",
  "background": "gradient1-11 중 하나",
  "animation": "pulse|bounce|fade|glow 중 하나"
}

특별 지시사항:
1. 반드시 11장의 슬라이드 생성
2. 첫 번째는 인트로, 마지막은 연락처
3. 중간에 기능, 장점, 통계 등 배치
4. 연락처/위치 정보가 있으면 별도 슬라이드로
5. JSON 배열 형태로만 응답 (다른 텍스트 없이)
6. 배열은 반드시 [ ] 로 시작하고 끝나야 함`
                    }, {
                        role: "user", 
                        content: prompt
                    }],
                    max_tokens: 2000,
                    temperature: 0.7
                };

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    
                    if (response.status === 401) {
                        throw new Error('API 키가 유효하지 않습니다. 올바른 키를 입력해주세요.');
                    } else if (response.status === 429) {
                        throw new Error('API 요청 한도를 초과했습니다. 잠시 후 다시 시도해주세요.');
                    } else if (response.status === 403) {
                        throw new Error('API 크레딧이 부족합니다. 계정을 확인해주세요.');
                    } else {
                        throw new Error(`API 호출 실패: ${response.status} - ${errorText}`);
                    }
                }

                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('API 응답 형식이 올바르지 않습니다.');
                }

                console.log('✅ GPT-4 API 응답 수신');
                return data.choices[0].message.content;
                
            } catch (error) {
                console.error(`❌ GPT API 호출 오류 (시도 ${retryCount + 1}):`, error);
                
                // 네트워크 오류나 일시적 오류의 경우 재시도
                if (retryCount < maxRetries && 
                    (error.message.includes('fetch') || 
                     error.message.includes('429') || 
                     error.message.includes('502') || 
                     error.message.includes('503'))) {
                    
                    console.log(`🔄 ${2000 * (retryCount + 1)}ms 후 재시도...`);
                    await new Promise(resolve => setTimeout(resolve, 2000 * (retryCount + 1)));
                    return callGPTAPI(prompt, retryCount + 1);
                }
                
                throw error;
            }
        }

        // AI 슬라이드 생성 메인 함수 - 완전 재작성
        async function generateAISlides() {
            // 중복 실행 방지
            if (isGenerating) {
                console.warn('⚠️ 이미 생성 중입니다.');
                return;
            }

            try {
                isGenerating = true;

                // 입력값 검증
                const titleElement = safeGetElement('titleInput');
                const contentElement = safeGetElement('contentInput');
                const colorThemeElement = safeGetElement('colorTheme');

                if (!titleElement || !contentElement || !colorThemeElement) {
                    throw new Error('필수 입력 필드를 찾을 수 없습니다.');
                }

                const title = titleElement.value.trim();
                const content = contentElement.value.trim();
                const colorTheme = colorThemeElement.value;

                // API 키 검증
                if (!isApiKeyValid || !apiKey) {
                    alert('먼저 OpenAI API 키를 설정해주세요!');
                    return;
                }

                // 입력값 검증
                if (!title || !content) {
                    alert('제목과 내용을 모두 입력해주세요!');
                    return;
                }

                if (title.length > 100) {
                    alert('제목은 100자 이하로 입력해주세요.');
                    return;
                }

                if (content.length > 5000) {
                    alert('내용은 5000자 이하로 입력해주세요.');
                    return;
                }

                // UI 상태 초기화
                const generateButton = safeGetElement('generateButton');
                if (generateButton) generateButton.disabled = true;

                safeToggleClass('statusPanel', 'show', 'add');
                
                const aiThinking = safeGetElement('aiThinking');
                if (aiThinking) aiThinking.style.display = 'flex';

                // 1. GPT API로 내용 분석
                safeSetContent('statusTitle', '🧠 GPT-4가 당신의 내용을 지능적으로 분석 중...');
                
                const prompt = `템플릿: ${selectedTemplate}
제목: ${title}
내용: ${content}
컬러테마: ${colorTheme}

위 정보를 바탕으로 11장의 유튜브 쇼츠용 슬라이드 구조를 생성해주세요.`;

                const gptResponse = await callGPTAPI(prompt);
                
                // 2. AI 응답 파싱
                safeSetContent('statusTitle', '🎨 AI가 생성한 구조를 슬라이드로 변환 중...');
                
                let slideStructure;
                try {
                    // JSON 파싱 개선
                    let cleanResponse = gptResponse.trim();
                    
                    // 마크다운 코드 블록 제거
                    cleanResponse = cleanResponse.replace(/```json\s*/g, '').replace(/```\s*/g, '');
                    
                    // 불필요한 텍스트 제거
                    cleanResponse = cleanResponse.replace(/^[^[\{]*/, '').replace(/[^}\]]*$/, '');
                    
                    slideStructure = JSON.parse(cleanResponse);
                    
                    // 배열이 아닌 경우 배열로 변환
                    if (!Array.isArray(slideStructure)) {
                        slideStructure = [slideStructure];
                    }
                    
                    // 슬라이드 수 검증
                    if (slideStructure.length !== 11) {
                        console.warn(`⚠️ AI가 ${slideStructure.length}장의 슬라이드를 생성했습니다. 11장으로 조정합니다.`);
                        slideStructure = adjustSlideCount(slideStructure, title, content);
                    }
                    
                } catch (parseError) {
                    console.warn('⚠️ JSON 파싱 실패, 백업 구조 사용:', parseError);
                    slideStructure = createBackupStructure(title, content);
                }

                // 3. AI 분석 결과 표시
                aiAnalysisResult = slideStructure;
                safeToggleClass('aiAnalysis', 'hidden', 'remove');
                
                const analysisHTML = `
                    <strong>📊 AI가 분석한 내용 구조:</strong><br>
                    • 총 ${slideStructure.length}장의 슬라이드 생성<br>
                    • 템플릿: ${selectedTemplate}<br>
                    • 컬러 테마: ${colorTheme}<br>
                    • 특별 요소: ${slideStructure.filter(s => s.type === 'stats').length}개 통계, ${slideStructure.filter(s => s.type === 'contact').length}개 연락처<br>
                    • AI 추천 애니메이션: ${[...new Set(slideStructure.map(s => s.animation))].join(', ')}
                `;
                safeSetContent('analysisResult', analysisHTML, true);

                // 4. HTML 생성
                safeSetContent('statusTitle', '🎬 유튜브 쇼츠 최적화 영상 생성 중...');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                generatedSlideHTML = createAdvancedSlideHTML(slideStructure, colorTheme);
                
                // 5. 완료
                if (aiThinking) aiThinking.style.display = 'none';
                safeSetContent('statusTitle', '✅ 실제 AI 슬라이드 생성 완료!');
                safeToggleClass('statusPanel', 'show', 'remove');
                
                // 6. 미리보기 표시
                showAIPreview();
                if (generateButton) generateButton.disabled = false;
                
                console.log('🎊 AI 슬라이드 생성 완료!');
                
            } catch (error) {
                console.error('❌ AI 생성 오류:', error);
                
                // UI 오류 상태 처리
                const aiThinking = safeGetElement('aiThinking');
                if (aiThinking) aiThinking.style.display = 'none';
                
                let errorMessage = `❌ 오류: ${error.message}`;
                
                // 특정 오류 유형별 처리
                if (error.message.includes('401') || error.message.includes('API 키')) {
                    errorMessage = '❌ API 키 오류: OpenAI API 키를 확인해주세요.<br><small>크레딧이 부족하거나 잘못된 키일 수 있습니다.</small>';
                } else if (error.message.includes('429')) {
                    errorMessage = '❌ 요청 한도 초과: 잠시 후 다시 시도해주세요.<br><small>API 사용량이 많아서 대기가 필요합니다.</small>';
                } else if (error.message.includes('fetch')) {
                    errorMessage = '❌ 네트워크 오류: 인터넷 연결을 확인해주세요.<br><small>방화벽이나 프록시 설정을 확인해보세요.</small>';
                }
                
                safeSetContent('statusTitle', errorMessage, true);
                
                setTimeout(() => {
                    safeToggleClass('statusPanel', 'show', 'remove');
                    const generateButton = safeGetElement('generateButton');
                    if (generateButton) generateButton.disabled = false;
                }, 5000);
                
            } finally {
                isGenerating = false;
            }
        }

        // 슬라이드 수 조정 함수
        function adjustSlideCount(slides, title, content) {
            const targetCount = 11;
            
            if (slides.length < targetCount) {
                // 슬라이드 수가 부족한 경우 추가
                const additionalSlides = createAdditionalSlides(title, content, targetCount - slides.length);
                return [...slides, ...additionalSlides];
            } else if (slides.length > targetCount) {
                // 슬라이드 수가 많은 경우 중요한 것만 선택
                return selectImportantSlides(slides, targetCount);
            }
            
            return slides;
        }

        // 추가 슬라이드 생성
        function createAdditionalSlides(title, content, count) {
            const additionalSlides = [];
            const types = ['feature', 'stats', 'testimonial'];
            
            for (let i = 0; i < count; i++) {
                additionalSlides.push({
                    slideNumber: 11 - count + i + 1,
                    type: types[i % types.length],
                    title: `특징 ${i + 1}`,
                    subtitle: '상세 설명',
                    icon: getSmartIcon('기본', i),
                    background: `gradient${(i % 9) + 2}`,
                    animation: ['pulse', 'bounce', 'fade', 'glow'][i % 4]
                });
            }
            
            return additionalSlides;
        }

        // 중요한 슬라이드 선택
        function selectImportantSlides(slides, targetCount) {
            // 인트로와 연락처는 필수
            const intro = slides.find(s => s.type === 'intro') || slides[0];
            const contact = slides.find(s => s.type === 'contact') || slides[slides.length - 1];
            
            // 나머지 슬라이드 중에서 선택
            const others = slides.filter(s => s.type !== 'intro' && s.type !== 'contact')
                                 .slice(0, targetCount - 2);
            
            return [intro, ...others, contact].map((slide, index) => ({
                ...slide,
                slideNumber: index + 1
            }));
        }

        // 백업 구조 생성 - 개선된 버전
        function createBackupStructure(title, content) {
            try {
                const lines = content.split('\n').filter(line => line.trim());
                const features = lines.filter(line => line.includes('-') || line.includes(':')).slice(0, 6);
                
                const baseSlides = [
                    { 
                        slideNumber: 1, 
                        type: "intro", 
                        title: title.length > 25 ? title.substring(0, 22) + '...' : title, 
                        subtitle: "혁신적인 솔루션", 
                        icon: "🚀", 
                        background: "gradient1", 
                        animation: "glow" 
                    },
                    { 
                        slideNumber: 2, 
                        type: "brand", 
                        title: (title.split('-')[0] || title).substring(0, 25), 
                        subtitle: "브랜드 소개", 
                        icon: "⭐", 
                        background: "gradient2", 
                        animation: "bounce" 
                    }
                ];

                const featureSlides = features.map((feature, i) => ({
                    slideNumber: i + 3,
                    type: "feature", 
                    title: (feature.split(':')[0].replace('-', '').trim()).substring(0, 25),
                    subtitle: (feature.split(':')[1]?.trim() || '상세 설명').substring(0, 50),
                    icon: getSmartIcon(feature, i),
                    background: `gradient${(i % 9) + 3}`,
                    animation: ['pulse', 'bounce', 'fade', 'glow'][i % 4]
                }));

                const contactSlide = { 
                    slideNumber: 11, 
                    type: "contact", 
                    title: "연락처", 
                    subtitle: "상담 문의", 
                    icon: "📞", 
                    background: "gradient11", 
                    animation: "bounce" 
                };

                // 11장 맞추기
                const allSlides = [...baseSlides, ...featureSlides, contactSlide];
                return allSlides.slice(0, 11).map((slide, index) => ({
                    ...slide,
                    slideNumber: index + 1
                }));
                
            } catch (error) {
                console.error('❌ 백업 구조 생성 오류:', error);
                return createMinimalStructure(title);
            }
        }

        // 최소 구조 생성 (에러 시 최후 수단)
        function createMinimalStructure(title) {
            const minimalSlides = [];
            for (let i = 1; i <= 11; i++) {
                minimalSlides.push({
                    slideNumber: i,
                    type: i === 1 ? 'intro' : (i === 11 ? 'contact' : 'feature'),
                    title: i === 1 ? title : (i === 11 ? '연락처' : `내용 ${i - 1}`),
                    subtitle: i === 1 ? '소개' : (i === 11 ? '문의하기' : '상세 설명'),
                    icon: ['🚀', '⭐', '🎯', '💬', '🤖', '⚡', '💝', '🔥', '✨', '🎊', '📞'][i - 1],
                    background: `gradient${i}`,
                    animation: ['glow', 'bounce', 'pulse', 'fade'][i % 4]
                });
            }
            return minimalSlides;
        }

        // 스마트 아이콘 선택 - 확장된 버전
        function getSmartIcon(text, index) {
            const icons = ['🧠', '🎯', '💬', '🤖', '⚡', '💝', '🔥', '✨', '🎊', '🏆'];
            
            if (!text || typeof text !== 'string') {
                return icons[index % icons.length];
            }

            const lowerText = text.toLowerCase();
            
            // 키워드 기반 아이콘 매핑
            const iconMap = {
                'ai': '🤖', '인공지능': '🤖', 'artificial': '🤖',
                '속독': '🎯', '빠른': '🎯', 'fast': '🎯', 'speed': '🎯',
                '토론': '💬', '대화': '💬', 'talk': '💬', 'chat': '💬',
                '피드백': '⚡', '즉석': '⚡', 'feedback': '⚡', 'instant': '⚡',
                '분석': '🧠', '독해': '🧠', 'analysis': '🧠', 'brain': '🧠',
                '성과': '🏆', '결과': '🏆', 'result': '🏆', 'achievement': '🏆',
                '혜택': '💝', '할인': '💝', 'benefit': '💝', 'discount': '💝',
                '혁신': '🔥', '새로운': '🔥', 'innovation': '🔥', 'new': '🔥'
            };

            for (const [keyword, icon] of Object.entries(iconMap)) {
                if (lowerText.includes(keyword)) {
                    return icon;
                }
            }
            
            return icons[index % icons.length];
        }

        // 고급 슬라이드 HTML 생성 - 안전성 강화
        function createAdvancedSlideHTML(slides, colorTheme) {
            try {
                if (!Array.isArray(slides) || slides.length === 0) {
                    throw new Error('유효하지 않은 슬라이드 데이터');
                }

                const colors = getColorTheme(colorTheme);
                const backgrounds = getBackgroundStyles(colors);
                
                let slidesHTML = '';
                
                slides.forEach((slide, index) => {
                    // 슬라이드 데이터 검증 및 기본값 설정
                    const safeSlide = {
                        slideNumber: slide.slideNumber || (index + 1),
                        type: slide.type || 'feature',
                        title: (slide.title || '제목').substring(0, 30),
                        subtitle: (slide.subtitle || '설명').substring(0, 60),
                        icon: slide.icon || '⭐',
                        background: slide.background || 'gradient1',
                        animation: slide.animation || 'pulse'
                    };

                    const isActive = index === 0 ? 'active' : '';
                    const bgStyle = backgrounds[safeSlide.background] || backgrounds.gradient1;
                    
                    slidesHTML += `
                    <div class="slide ${isActive}" data-slide="${index}" style="${bgStyle}">
                        <div class="slide-content">
                            <div class="big-icon" style="animation: ${safeSlide.animation} 2s infinite;">${safeSlide.icon}</div>
                            <div class="slide-title" style="color: ${colors.accent};">${safeSlide.title}</div>
                            <div class="slide-desc">${safeSlide.subtitle}</div>
                        </div>
                        <div class="slide-indicator">${safeSlide.slideNumber}/11</div>
                    </div>`;
                });

                return createSlideHTMLTemplate(slidesHTML, slides.length);
                
            } catch (error) {
                console.error('❌ 슬라이드 HTML 생성 오류:', error);
                return createErrorSlideHTML();
            }
        }

        // 슬라이드 HTML 템플릿 생성
        function createSlideHTMLTemplate(slidesHTML, totalSlides) {
            return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Generated Slides</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: #000; 
            overflow: hidden; 
            font-family: 'Arial', sans-serif; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .container { 
            width: 405px; 
            height: 720px; 
            background: #000; 
            border-radius: 25px; 
            position: relative; 
            overflow: hidden; 
            border: 3px solid #333; 
        }
        .slide { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            opacity: 0; 
            transition: all 0.8s ease; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            padding: 40px 25px; 
            color: white; 
        }
        .slide.active { opacity: 1; }
        .slide-content { 
            width: 100%; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100%; 
        }
        .slide-title { 
            font-size: 2.2em; 
            font-weight: 900; 
            margin-bottom: 20px; 
            line-height: 1.1; 
            text-shadow: 0 0 25px rgba(255,255,255,0.8); 
            word-wrap: break-word;
        }
        .slide-desc { 
            font-size: 1.1em; 
            line-height: 1.4; 
            opacity: 0.95; 
            word-wrap: break-word;
        }
        .big-icon { 
            font-size: 4em; 
            margin-bottom: 25px; 
            filter: drop-shadow(0 0 15px rgba(255,255,255,0.6)); 
        }
        .slide-indicator { 
            position: absolute; 
            top: 20px; 
            right: 20px; 
            font-size: 0.9em; 
            background: rgba(0,0,0,0.7); 
            padding: 8px 15px; 
            border-radius: 15px; 
            border: 1px solid rgba(255,255,255,0.2); 
        }
        @keyframes pulse { 
            0%, 100% { transform: scale(1); } 
            50% { transform: scale(1.1); } 
        }
        @keyframes bounce { 
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); } 
            40% { transform: translateY(-15px); } 
            60% { transform: translateY(-8px); } 
        }
        @keyframes fade { 
            0%, 100% { opacity: 0.8; } 
            50% { opacity: 1; } 
        }
        @keyframes glow { 
            0%, 100% { text-shadow: 0 0 20px rgba(255,255,255,0.8); } 
            50% { text-shadow: 0 0 35px rgba(0,255,255,0.9); } 
        }
    </style>
</head>
<body>
    <div class="container">
        ${slidesHTML}
    </div>
    <script>
        let current = 0;
        const total = ${totalSlides};
        
        function next() {
            try {
                const slides = document.querySelectorAll('.slide');
                if (slides.length === 0) return false;
                
                slides.forEach(s => s.classList.remove('active'));
                current = (current + 1) % total;
                
                const nextSlide = slides[current];
                if (nextSlide) {
                    nextSlide.classList.add('active');
                    return current !== 0;
                }
                return false;
            } catch (error) {
                console.error('❌ 슬라이드 전환 오류:', error);
                return false;
            }
        }
        
        function start() {
            try {
                const slides = document.querySelectorAll('.slide');
                if (slides.length === 0) {
                    console.error('❌ 슬라이드가 없습니다.');
                    return;
                }
                
                const firstSlide = slides[0];
                if (firstSlide) {
                    firstSlide.classList.add('active');
                }
                
                const interval = setInterval(() => {
                    if (!next()) {
                        clearInterval(interval);
                        console.log('✅ 슬라이드쇼 완료');
                    }
                }, 2500);
                
                console.log('🤖 실제 AI 생성 슬라이드쇼 시작!');
            } catch (error) {
                console.error('❌ 슬라이드쇼 시작 오류:', error);
            }
        }
        
        // 1초 후 자동 시작
        setTimeout(start, 1000);
        
        // 윈도우 리사이즈 이벤트 처리
        window.addEventListener('resize', function() {
            try {
                const container = document.querySelector('.container');
                if (container) {
                    // 컨테이너 크기 재조정 로직
                    console.log('🔄 화면 크기 조정됨');
                }
            } catch (error) {
                console.error('❌ 리사이즈 처리 오류:', error);
            }
        });
        
        // 에러 핸들링
        window.addEventListener('error', function(e) {
            console.error('❌ 슬라이드쇼 전역 오류:', e.error);
        });
    </script>
</body>
</html>`;
        }

        // 에러 슬라이드 HTML 생성 (백업용)
        function createErrorSlideHTML() {
            return `
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Error - AI Slide Generator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            background: linear-gradient(135deg, #ff6b6b 0%, #764ba2 100%); 
            overflow: hidden; 
            font-family: Arial; 
            height: 100vh; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .container { 
            width: 405px; 
            height: 720px; 
            background: #000; 
            border-radius: 25px; 
            position: relative; 
            overflow: hidden; 
            border: 3px solid #333; 
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            padding: 40px;
        }
        .error-content {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .error-icon { font-size: 4em; margin-bottom: 20px; }
        .error-title { font-size: 1.8em; font-weight: 900; margin-bottom: 15px; }
        .error-desc { font-size: 1em; opacity: 0.8; line-height: 1.4; }
    </style>
</head>
<body>
    <div class="container">
        <div class="error-content">
            <div class="error-icon">⚠️</div>
            <div class="error-title">슬라이드 생성 오류</div>
            <div class="error-desc">슬라이드를 생성하는 중 오류가 발생했습니다.<br>다시 시도해주세요.</div>
        </div>
    </div>
</body>
</html>`;
        }

        // 컬러 테마 가져오기 - 안전성 강화
        function getColorTheme(theme) {
            const themes = {
                'blue-purple': { primary: '#667eea', secondary: '#764ba2', accent: '#00ffff' },
                'red-orange': { primary: '#ff6b6b', secondary: '#ff8e53', accent: '#ffff00' },
                'green-teal': { primary: '#11998e', secondary: '#38ef7d', accent: '#00ff00' },
                'purple-pink': { primary: '#a8edea', secondary: '#fed6e3', accent: '#ff00ff' },
                'dark-neon': { primary: '#0f0f0f', secondary: '#1a1a1a', accent: '#00ffff' },
                'auto': { primary: '#667eea', secondary: '#764ba2', accent: '#00ffff' }
            };
            
            return themes[theme] || themes['blue-purple'];
        }

        // 배경 스타일 가져오기 - 안전성 강화
        function getBackgroundStyles(colors) {
            if (!colors || !colors.primary || !colors.secondary) {
                console.warn('⚠️ 컬러 정보가 불완전합니다. 기본값 사용.');
                colors = { primary: '#667eea', secondary: '#764ba2' };
            }
            
            return {
                gradient1: `background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.secondary} 100%);`,
                gradient2: `background: radial-gradient(circle, #000428 0%, #004e92 100%);`,
                gradient3: `background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);`,
                gradient4: `background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);`,
                gradient5: `background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);`,
                gradient6: `background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);`,
                gradient7: `background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);`,
                gradient8: `background: linear-gradient(135deg, #0f0f0f 0%, #2d1b69 50%, #11998e 100%);`,
                gradient9: `background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);`,
                gradient10: `background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);`,
                gradient11: `background: linear-gradient(135deg, ${colors.primary} 0%, ${colors.secondary} 100%);`
            };
        }

        // AI 미리보기 표시 - 강화된 버전
        function showAIPreview() {
            try {
                const previewSection = safeGetElement('previewSection');
                const slidePreview = safeGetElement('slidePreview');
                
                if (!previewSection || !slidePreview) {
                    console.warn('⚠️ 미리보기 요소를 찾을 수 없습니다.');
                    return;
                }

                const slideCount = aiAnalysisResult?.length || 11;
                const previewHTML = `
                    <div style="display: flex; justify-content: center; align-items: center; height: 100%; color: white; text-align: center; flex-direction: column;">
                        <div style="font-size: 3em; margin-bottom: 20px; animation: pulse 2s infinite;">🤖</div>
                        <div style="font-size: 1.2em; margin-bottom: 10px; font-weight: bold;">실제 AI 슬라이드 생성 완료!</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-bottom: 10px;">GPT-4가 분석한 ${slideCount}장의 전문 슬라이드</div>
                        <div style="font-size: 0.8em; opacity: 0.6; margin-top: 10px;">템플릿: ${selectedTemplate}</div>
                        <div style="font-size: 0.7em; opacity: 0.5; margin-top: 5px;">27.5초 최적화 영상</div>
                    </div>
                `;
                
                slidePreview.innerHTML = previewHTML;
                previewSection.classList.add('show');
                
                console.log('✅ AI 미리보기 표시 완료');
            } catch (error) {
                console.error('❌ 미리보기 표시 오류:', error);
            }
        }

        // 녹화 시작 - 완전 재작성 및 강화
        async function startRecording() {
            if (!generatedSlideHTML) {
                alert('먼저 AI 슬라이드를 생성해주세요!');
                return;
            }

            try {
                // 브라우저 호환성 검사
                if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                    throw new Error('이 브라우저는 화면 녹화를 지원하지 않습니다. Chrome을 사용해주세요.');
                }

                const statusPanel = safeGetElement('statusPanel');
                const countdown = safeGetElement('countdown');
                const progressContainer = safeGetElement('progressContainer');
                const recordingStatus = safeGetElement('recordingStatus');

                if (!statusPanel) {
                    throw new Error('상태 패널을 찾을 수 없습니다.');
                }

                safeToggleClass('statusPanel', 'show', 'add');
                safeSetContent('statusTitle', '🎬 AI 생성 슬라이드쇼 창 열기...');

                // 슬라이드쇼 창 열기
                const blob = new Blob([generatedSlideHTML], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                
                // 팝업 차단 대비
                slideshowWindow = window.open(url, 'slideshow', 'width=450,height=800,resizable=yes,scrollbars=yes');

                if (!slideshowWindow || slideshowWindow.closed) {
                    throw new Error('팝업이 차단되었습니다. 브라우저 설정에서 팝업을 허용하고 다시 시도해주세요.');
                }

                // 슬라이드쇼 창 로드 대기
                await new Promise(resolve => setTimeout(resolve, 2000));

                // 화면 공유 요청
                safeSetContent('statusTitle', '🖥️ 화면 공유 권한 요청');
                
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { 
                        width: { ideal: 405, max: 1920 }, 
                        height: { ideal: 720, max: 1080 },
                        frameRate: { ideal: 30 }
                    },
                    audio: false
                });

                // MediaRecorder 설정 - 코덱 호환성 검사
                recordedChunks = [];
                let options = { mimeType: 'video/webm;codecs=vp9' };
                
                if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                    options = { mimeType: 'video/webm;codecs=vp8' };
                    if (!MediaRecorder.isTypeSupported(options.mimeType)) {
                        options = { mimeType: 'video/webm' };
                    }
                }

                mediaRecorder = new MediaRecorder(stream, options);
                
                // 이벤트 리스너 설정
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data && event.data.size > 0) {
                        recordedChunks.push(event.data);
                        console.log(`📊 녹화 데이터 수신: ${event.data.size} bytes`);
                    }
                };

                mediaRecorder.onstop = () => {
                    try {
                        console.log('🎬 녹화 완료, 데이터 처리 중...');
                        const videoBlob = new Blob(recordedChunks, { type: options.mimeType });
                        downloadVideo(videoBlob);
                        
                        // 스트림 정리
                        stream.getTracks().forEach(track => {
                            track.stop();
                            console.log('🔴 미디어 트랙 종료:', track.kind);
                        });
                        
                        // 슬라이드쇼 창 닫기
                        if (slideshowWindow && !slideshowWindow.closed) {
                            slideshowWindow.close();
                        }
                        
                        // URL 객체 정리
                        URL.revokeObjectURL(url);
                        
                    } catch (error) {
                        console.error('❌ 녹화 완료 처리 오류:', error);
                        alert('녹화는 완료되었지만 파일 처리 중 오류가 발생했습니다.');
                    }
                };

                mediaRecorder.onerror = (event) => {
                    console.error('❌ MediaRecorder 오류:', event.error);
                    throw new Error(`녹화 중 오류: ${event.error?.message || '알 수 없는 오류'}`);
                };

                // 카운트다운 시작
                safeSetContent('statusTitle', '🎬 AI 영상 녹화 시작 준비');
                
                if (countdown) {
                    countdown.classList.remove('hidden');
                }
                
                let count = 5;
                safeSetContent('countdown', count.toString());
                
                const countInterval = setInterval(() => {
                    count--;
                    if (count > 0) {
                        safeSetContent('countdown', count.toString());
                    } else {
                        safeSetContent('countdown', '시작!');
                        clearInterval(countInterval);
                        
                        setTimeout(() => {
                            if (countdown) countdown.classList.add('hidden');
                            
                            // 녹화 시작
                            try {
                                mediaRecorder.start(100); // 100ms마다 데이터 수집
                                console.log('🔴 녹화 시작됨');
                                
                                safeSetContent('statusTitle', '🔴 AI 생성 영상 제작 중...');
                                
                                if (recordingStatus) recordingStatus.classList.add('active');
                                if (progressContainer) progressContainer.classList.remove('hidden');
                                
                                // 진행률 표시
                                startProgressIndicator();
                                
                            } catch (startError) {
                                console.error('❌ 녹화 시작 오류:', startError);
                                throw new Error('녹화를 시작할 수 없습니다: ' + startError.message);
                            }
                            
                        }, 1000);
                    }
                }, 1000);

            } catch (error) {
                console.error('❌ 녹화 시작 오류:', error);
                safeSetContent('statusTitle', '❌ 오류: ' + error.message);
                
                // 정리 작업
                if (slideshowWindow && !slideshowWindow.closed) {
                    slideshowWindow.close();
                }
                
                setTimeout(() => {
                    safeToggleClass('statusPanel', 'show', 'remove');
                }, 5000);
            }
        }

        // 진행률 표시기 시작
        function startProgressIndicator() {
            try {
                let progress = 0;
                const duration = 27500; // 27.5초
                const updateInterval = 100; // 100ms마다 업데이트
                
                const progressFill = safeGetElement('progressFill');
                const progressText = safeGetElement('progressText');
                const recordingStatus = safeGetElement('recordingStatus');
                
                const progressInterval = setInterval(() => {
                    progress += updateInterval;
                    const percentage = Math.min((progress / duration) * 100, 100);
                    
                    if (progressFill) {
                        progressFill.style.width = percentage + '%';
                    }
                    
                    if (progressText) {
                        progressText.textContent = Math.round(percentage) + '% 완료';
                    }
                    
                    // 진행률에 따른 메시지 변경
                    if (percentage === 25) {
                        safeSetContent('statusTitle', '🎬 AI 슬라이드 전환 중... (1/4)');
                    } else if (percentage === 50) {
                        safeSetContent('statusTitle', '🎨 디자인 요소 적용 중... (2/4)');
                    } else if (percentage === 75) {
                        safeSetContent('statusTitle', '⚡ 최종 효과 처리 중... (3/4)');
                    } else if (percentage >= 95) {
                        safeSetContent('statusTitle', '✨ 마무리 중...');
                    }
                    
                    if (progress >= duration) {
                        clearInterval(progressInterval);
                        
                        // 녹화 중지
                        if (mediaRecorder && mediaRecorder.state === 'recording') {
                            mediaRecorder.stop();
                            console.log('⏹️ 녹화 중지됨');
                        }
                        
                        if (recordingStatus) recordingStatus.classList.remove('active');
                        safeSetContent('statusTitle', '✅ AI 영상 제작 완료!');
                    }
                }, updateInterval);
                
            } catch (error) {
                console.error('❌ 진행률 표시 오류:', error);
            }
        }

        // 영상 다운로드 - 강화된 버전
        function downloadVideo(blob) {
            try {
                if (!blob || blob.size === 0) {
                    throw new Error('녹화된 데이터가 없습니다.');
                }

                console.log(`📦 영상 파일 크기: ${(blob.size / 1024 / 1024).toFixed(2)} MB`);

                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const now = new Date();
                
                // 안전한 파일명 생성
                const titleElement = safeGetElement('titleInput');
                const rawTitle = titleElement ? titleElement.value : 'AI_Slide';
                const safeTitle = rawTitle.replace(/[^a-zA-Z0-9가-힣\s]/g, '_').substring(0, 30);
                
                const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2,'0')}${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}${now.getMinutes().toString().padStart(2,'0')}`;
                const filename = `AI_Generated_${safeTitle}_${timestamp}.webm`;
                
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                console.log('🤖 AI 생성 영상 다운로드 완료:', filename);
                
                // URL 정리
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                }, 1000);
                
                // UI 정리
                setTimeout(() => {
                    safeToggleClass('statusPanel', 'show', 'remove');
                }, 3000);
                
            } catch (error) {
                console.error('❌ 영상 다운로드 오류:', error);
                alert('영상 다운로드 중 오류가 발생했습니다: ' + error.message);
            }
        }

        // 초기화 함수 - 완전 재작성
        function init() {
            try {
                console.log('🚀 AI 슬라이드 생성기 초기화 시작...');

                // 브라우저 호환성 검사
                const compatibility = checkBrowserCompatibility();
                if (!compatibility.isCompatible) {
                    handleIncompatibleBrowser(compatibility.issues);
                    return;
                }

                // 필수 DOM 요소 검사
                const requiredElements = [
                    'apiKeyInput', 'apiSetup', 'generateButton', 
                    'titleInput', 'contentInput', 'colorTheme'
                ];
                
                const missingElements = requiredElements.filter(id => !safeGetElement(id));
                if (missingElements.length > 0) {
                    console.error('❌ 필수 요소 누락:', missingElements);
                    return;
                }

                // 템플릿 선택 이벤트 등록
                initTemplateSelection();
                
                // 입력 필드 검증 이벤트 등록
                initInputValidation();
                
                // 키보드 단축키 등록
                initKeyboardShortcuts();
                
                console.log('🤖 실제 AI 슬라이드 생성기 로드 완료!');
                console.log('🧠 OpenAI GPT-4 API 연동 준비');
                console.log('✨ 실제 AI가 분석하고 생성하는 슬라이드');
                
            } catch (error) {
                console.error('❌ 초기화 오류:', error);
                alert('애플리케이션 초기화 중 오류가 발생했습니다. 페이지를 새로고침해주세요.');
            }
        }

        // 브라우저 호환성 검사
        function checkBrowserCompatibility() {
            const issues = [];
            let isCompatible = true;

            // 필수 API 검사
            if (!navigator.mediaDevices || !navigator.mediaDevices.getDisplayMedia) {
                issues.push('화면 녹화 API');
                isCompatible = false;
            }

            if (!window.MediaRecorder) {
                issues.push('MediaRecorder API');
                isCompatible = false;
            }

            if (!window.fetch) {
                issues.push('Fetch API');
                isCompatible = false;
            }

            if (!window.Promise) {
                issues.push('Promise');
                isCompatible = false;
            }

            return { isCompatible, issues };
        }

        // 호환되지 않는 브라우저 처리
        function handleIncompatibleBrowser(issues) {
            const generateButton = safeGetElement('generateButton');
            if (generateButton) {
                generateButton.textContent = '⚠️ 브라우저가 지원되지 않습니다 (Chrome 권장)';
                generateButton.disabled = true;
                generateButton.style.background = '#ff6b6b';
            }

            const errorMessage = `❌ 브라우저 호환성 문제\n\n지원되지 않는 기능:\n${issues.join(', ')}\n\n권장 브라우저: Chrome 최신 버전`;
            
            safeSetContent('apiStatus', errorMessage.replace(/\n/g, '<br>'), true);
            
            console.error('❌ 브라우저 호환성 문제:', issues);
        }

        // 입력 검증 이벤트 등록
        function initInputValidation() {
            try {
                const titleInput = safeGetElement('titleInput');
                const contentInput = safeGetElement('contentInput');

                if (titleInput) {
                    titleInput.addEventListener('input', function() {
                        const length = this.value.length;
                        if (length > 100) {
                            this.style.borderColor = '#ff6b6b';
                            console.warn('⚠️ 제목이 너무 깁니다.');
                        } else {
                            this.style.borderColor = '';
                        }
                    });
                }

                if (contentInput) {
                    contentInput.addEventListener('input', function() {
                        const length = this.value.length;
                        if (length > 5000) {
                            this.style.borderColor = '#ff6b6b';
                            console.warn('⚠️ 내용이 너무 깁니다.');
                        } else {
                            this.style.borderColor = '';
                        }
                    });
                }

                console.log('✅ 입력 검증 이벤트 등록 완료');
            } catch (error) {
                console.error('❌ 입력 검증 초기화 오류:', error);
            }
        }

        // 키보드 단축키 등록
        function initKeyboardShortcuts() {
            try {
                document.addEventListener('keydown', function(e) {
                    // Ctrl + Enter: 슬라이드 생성
                    if (e.ctrlKey && e.key === 'Enter') {
                        e.preventDefault();
                        if (!isGenerating && isApiKeyValid) {
                            generateAISlides();
                        }
                    }
                    
                    // Escape: 상태 패널 닫기
                    if (e.key === 'Escape') {
                        const statusPanel = safeGetElement('statusPanel');
                        if (statusPanel && statusPanel.classList.contains('show')) {
                            statusPanel.classList.remove('show');
                        }
                    }
                });

                console.log('✅ 키보드 단축키 등록 완료');
            } catch (error) {
                console.error('❌ 키보드 단축키 초기화 오류:', error);
            }
        }

        // 전역 에러 핸들러
        window.addEventListener('error', function(e) {
            console.error('❌ 전역 오류:', e.error);
            
            // 사용자에게 친화적인 에러 메시지
            if (e.error && e.error.name === 'TypeError') {
                console.warn('⚠️ 타입 오류 발생, 계속 진행합니다.');
            } else {
                safeSetContent('statusTitle', '❌ 예상치 못한 오류가 발생했습니다.');
            }
        });

        // 약속 거부 핸들러
        window.addEventListener('unhandledrejection', function(e) {
            console.error('❌ 처리되지 않은 Promise 거부:', e.reason);
            e.preventDefault(); // 기본 오류 표시 방지
        });

        // DOM 로드 시 초기화
        document.addEventListener('DOMContentLoaded', init);

        // 페이지 언로드 시 정리
        window.addEventListener('beforeunload', function() {
            try {
                // 진행 중인 녹화 중지
                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    mediaRecorder.stop();
                }
                
                // 슬라이드쇼 창 닫기
                if (slideshowWindow && !slideshowWindow.closed) {
                    slideshowWindow.close();
                }
                
                console.log('🧹 리소스 정리 완료');
            } catch (error) {
                console.error('❌ 정리 작업 오류:', error);
            }
        });
    </script>
</body>
</html>
